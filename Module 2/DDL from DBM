CREATE TABLE calendar
(
 order_date date NOT NULL,
 ship_date  date NOT NULL,
 year       smallint NOT NULL,
 month      smallint NOT NULL,
 week       smallint NOT NULL,
 week_day   smallint NOT NULL,
quarter    smallint NOT NULL,
 CONSTRAINT PK_1 PRIMARY KEY ( order_date, ship_date )
);

INSERT INTO calendar (order_date, ship_date, year, month, week, week_day, quarter)
(SELECT ts, ts,
  EXTRACT(YEAR FROM ts),
  EXTRACT(MONTH FROM ts),
EXTRACT(WEEK FROM ts),
  EXTRACT(DOW FROM ts),
  EXTRACT(QUARTER FROM ts)

 
  FROM generate_series('2012-01-01'::timestamp, '2038-01-01', '1day'::interval) AS t(ts));



CREATE TABLE geography
(
 geo_id      serial NOT NULL,
 country     varchar(15) NOT NULL,
 city        varchar(17) NOT NULL,
 "state"       varchar(15) NOT NULL,
 region      varchar(11) NOT NULL,
 postal_code int4range NOT NULL,
 CONSTRAINT PK_2 PRIMARY KEY ( geo_id )
);

CREATE TABLE product
(
 product_id   serial NOT NULL,
 category     varchar(15) NOT NULL,
 subcategory  varchar(15) NOT NULL,
 segment      varchar(15) NOT NULL,
 product_name varchar(130) NOT NULL,
 CONSTRAINT PK_3 PRIMARY KEY ( product_id )
);

CREATE TABLE shipping
(
 ship_id   serial NOT NULL,
 ship_mode varchar(14) NOT NULL,
 CONSTRAINT PK_4 PRIMARY KEY ( ship_id )
);

CREATE TABLE sales
(
 row_id       int4range NOT NULL,
 order_id     varchar(50) NOT NULL,
 ship_id_1    int NOT NULL,
 geo_id_1     int NOT NULL,
 order_date_1 date NOT NULL,
 product_id_1 int NOT NULL,
 ship_date_1  date NOT NULL,
 sales        numeric(9,4) NOT NULL,
 quantity     int4range NOT NULL,
 discount     numeric(4,2) NOT NULL,
 profit       numeric(21,16) NOT NULL,
 order_date   date NOT NULL,
 ship_id      integer NOT NULL,
 product_id   integer NOT NULL,
 geo_id       integer NOT NULL,
 ship_date    date NOT NULL,
 CONSTRAINT PK_1 PRIMARY KEY ( row_id ),
 CONSTRAINT FK_1 FOREIGN KEY ( product_id_1 ) REFERENCES product ( product_id ),
 CONSTRAINT FK_2 FOREIGN KEY ( order_date_1, ship_date_1 ) REFERENCES calendar ( order_date, ship_date ),
 CONSTRAINT FK_3 FOREIGN KEY ( geo_id_1 ) REFERENCES geography ( geo_id ),
 CONSTRAINT FK_4 FOREIGN KEY ( ship_id_1 ) REFERENCES shipping ( ship_id )
);

CREATE INDEX FK_2 ON sales
(
 product_id_1
);

CREATE INDEX FK_3 ON sales
(
 order_date_1,
 ship_date_1
);

CREATE INDEX FK_4 ON sales
(
 geo_id_1
);

CREATE INDEX FK_5 ON sales
(
 ship_id_1
);
